# 2PC (两阶段提交协议) 演示程序

这是一个用Python 3.8实现的两阶段提交协议（Two-Phase Commit Protocol）演示系统。该系统包括一个协调者（Coordinator）和多个参与者（Participant），通过网络通信实现分布式事务的共识。

## 📋 功能特性

- ✅ 完整的2PC协议实现（准备阶段 + 提交/中止阶段）
- ✅ 协调者和参与者分离，可独立启动
- ✅ 基于TCP Socket的网络通信
- ✅ 支持多个参与者同时运行
- ✅ 交互式命令行界面
- ✅ 可配置的失败率模拟
- ✅ 实时事务状态跟踪
- 🆕 **手动投票机制** - 参与者手动决定投YES或NO
- 🆕 **Crash功能** - 模拟参与者崩溃
- 🆕 **Recover功能** - 从崩溃中恢复并同步历史日志

## 🏗️ 系统架构

```
┌─────────────────┐
│   Coordinator   │  (协调者)
│   Port: 5000    │
└────────┬────────┘
         │
    ┌────┴────┬────────────┐
    │         │            │
┌───▼──┐  ┌──▼───┐    ┌──▼───┐
│  P1  │  │  P2  │    │  P3  │  (参与者)
│ 6001 │  │ 6002 │    │ 6003 │
└──────┘  └──────┘    └──────┘
```

## 🚀 快速开始

### 1. 启动协调者

在第一个终端窗口中运行：

```bash
python coordinator.py
```

默认端口为5000。如果需要指定其他端口：

```bash
python coordinator.py 5000
```

### 2. 启动参与者

在其他终端窗口中分别启动多个参与者：

**终端 2:**
```bash
python participant.py P1 6001
```

**终端 3:**
```bash
python participant.py P2 6002
```

**终端 4:**
```bash
python participant.py P3 6003
```

参数说明：
- `P1`, `P2`, `P3`: 参与者ID（可自定义）
- `6001`, `6002`, `6003`: 参与者端口号
- 如需指定协调者端口：`python participant.py P1 6001 5000`

### 3. 执行事务

在协调者终端中：

```
coordinator> tx
请输入事务数据 (格式: key=value, 例: account=alice,amount=100):
data> account=alice,amount=100,operation=deposit
```

系统会自动执行2PC协议：
1. **阶段1（准备）**: 协调者向所有参与者发送PREPARE请求
2. **投票**: 参与者响应YES或NO
3. **阶段2（提交/中止）**: 
   - 如果所有参与者都投YES，协调者发送COMMIT
   - 如果有任何参与者投NO，协调者发送ABORT

## 📖 命令说明

### 协调者命令

| 命令 | 说明 |
|------|------|
| `list` | 列出所有已注册的参与者 |
| `tx` | 发起新事务 |
| `status` | 查看事务历史和状态 |
| `quit` | 退出协调者 |

### 参与者命令

| 命令 | 说明 |
|------|------|
| `status` | 查看参与者状态 |
| `data` | 查看已提交的事务数据 |
| `vote yes/no` | 🆕 对待投票事务投票 |
| `crash` | 🆕 模拟崩溃 |
| `recover` | 🆕 从崩溃中恢复并同步历史 |
| `fail` | 设置失败率（模拟网络故障） |
| `quit` | 退出参与者 |

## 🔬 协议流程示例

```
[协调者] 开始事务 TX-001
[协调者] ──PREPARE──> [P1, P2, P3]
[P1] <准备成功> ──VOTE_YES──> [协调者]
[P2] <准备成功> ──VOTE_YES──> [协调者]
[P3] <准备成功> ──VOTE_YES──> [协调者]
[协调者] 所有投票通过，决定提交
[协调者] ──COMMIT──> [P1, P2, P3]
[P1] <提交成功> ──ACK_COMMIT──> [协调者]
[P2] <提交成功> ──ACK_COMMIT──> [协调者]
[P3] <提交成功> ──ACK_COMMIT──> [协调者]
[协调者] 事务成功提交 ✓
```

## 🧪 测试场景

### 场景1: 正常提交

所有参与者都正常工作，事务应该成功提交。

### 场景2: 参与者拒绝

在某个参与者中设置失败率：
```
P2> fail
输入失败率 (0.0-1.0): 1.0
```

发起事务后，P2会投VOTE_NO，导致整个事务中止。

### 场景3: 多个参与者

启动4个或更多参与者，测试协调者能否正确管理多个节点。

### 场景4: 动态注册

在协调者运行期间，随时可以启动新的参与者加入网络。

## 📁 文件结构

```
2pc/
├── coordinator.py      # 协调者程序
├── participant.py      # 参与者程序
├── protocol.py         # 协议消息定义
├── requirements.txt    # 依赖（本项目仅用标准库）
└── README.md          # 本文档
```

## 🛠️ 技术实现

- **语言**: Python 3.8
- **网络**: TCP Socket
- **并发**: Threading（多线程）
- **序列化**: JSON
- **架构**: Client-Server模式

## 📝 协议消息类型

### 协调者 → 参与者
- `PREPARE`: 准备阶段请求
- `COMMIT`: 提交请求
- `ABORT`: 中止请求

### 参与者 → 协调者
- `VOTE_YES`: 投票同意
- `VOTE_NO`: 投票拒绝
- `ACK_COMMIT`: 确认提交
- `ACK_ABORT`: 确认中止

## ⚠️ 注意事项

1. 本系统是**演示程序**，用于学习和理解2PC协议，不适合生产环境
2. 没有实现持久化存储和故障恢复
3. 没有处理网络分区和超时恢复
4. 协调者是单点，没有实现协调者故障转移

## 🎓 学习要点

通过本演示，你可以学习到：
- 2PC协议的完整流程
- 分布式系统中的共识问题
- 网络编程和Socket通信
- 多线程并发处理
- 事务状态管理

## 📚 扩展思考

- 如果协调者在阶段2崩溃会怎样？
- 如果参与者在准备后、提交前崩溃会怎样？
- 2PC的性能瓶颈在哪里？
- 3PC（三阶段提交）如何改进2PC？
- Paxos和Raft等现代共识算法有什么优势？

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📄 License

MIT License

